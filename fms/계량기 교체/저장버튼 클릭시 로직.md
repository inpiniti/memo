# 저장버튼 클릭시 로직

---

## 1. 완료(저장) 버튼 클릭 시 흐름

1. 버튼 이벤트 처리
   - `SEND_YN`이 "Y": 이미 송신된 자료, 저장 불가
   - `SEND_YN`이 "S"이고 불가사유 없음: 완료 취소 여부 확인
   - 그 외:
     - `Set_Index()`로 인덱스 저장
     - `Validate()` 함수로 입력값 검증
     - 검증 통과 시 `Save_Result()` 호출

---

## 2. 입력값 검증(Validate)

- 필수값 누락: 각 항목별로 안내 메시지 출력, 저장 중단
- 사진 미촬영: "계량기 사진을 촬영하세요." 메시지
- AMI 정보 누락: "AMI정보는 필수입니다." 메시지 및 AMI 입력화면 이동
- 교체사유 변경: "교체사유 변경으로 진행을 확인합니다." 메시지
- 보정기/지침입력 필요: 별도 화면 이동

---

## 3. 실제 저장(Save_Result)

- `TREAT_FLAG = '10'`: 정상처리
- `SEND_YN = 'S'`: 저장(미송신)
- `AFTER_MTR_APPRO_YN = 'Y'`: 설치계량기 승인
- `JOB_DTM`, `VISIT_YMD` 등 날짜/시간 정보 저장
- 고객 서명 이미지 BASE64로 저장

---

## 4. 요약 흐름

1. 완료 버튼 클릭
2. 입력값 검증(Validate)
   - 필수값, 사진, AMI, 사유 등 체크
   - 고객 서명 입력
3. DB에 정상 교체 정보 저장
   - `TREAT_FLAG = '10'`, `SEND_YN = 'S'`, 기타 정보
4. 목록 화면 등으로 이동

---

## 5. 주요 저장 필드

| 필드명            | 설명                                                         |
| ----------------- | ------------------------------------------------------------ |
| AFTER*MTR*\*      | 설치계량기 정보(등급, 모델, 타입, 자리, 원격, 종류, 유효 등) |
| REMOVE_INDI_VC    | 철거계량기 지침                                              |
| INST_INDI_VC      | 설치계량기 지침                                              |
| MTR_REPL_WHY      | 교체사유                                                     |
| MTR_FEE_FREE_FLAG | 유상/무상 구분                                               |
| SEND_YN           | 'S'                                                          |
| TREAT_FLAG        | '10'                                                         |
| REPL_STS          | (정상 교체 시 별도 저장 없음, 불가 시만 '30')                |
| 고객 서명         | BASE64 인코딩                                                |

---

## 6. 참고

- 불가 처리와 달리 `REPL_STS`, `TREAT_FLAG`, `SEND_YN` 값이 각각 '10', 'S'로 저장됨
- 불가사유(`REPL_NOT_PERMIT_WHY`)는 저장되지 않음
- 사진, 서명 등 첨부파일도 함께 저장됨

---
